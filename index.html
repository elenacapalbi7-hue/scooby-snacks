let player;
let groundY;
let gravity = 0.6;
let jumpForce = -12;
let obstacles = [];
let cookies = [];
let score = 0;

let gameStarted = false;
let speed = 2; // velocidad inicial muy lenta

// Sonidos (pueden ser reemplazados por tus propios archivos o generadores)
let jumpSound;
let cookieSound;

function preload() {
  // Ejemplo de sonidos: p5 tiene loadSound si tienes archivos, aquí solo placeholders
  jumpSound = loadSound('https://freesound.org/data/previews/331/331912_3248244-lq.mp3');
  cookieSound = loadSound('https://freesound.org/data/previews/331/331912_3248244-lq.mp3');
}

function setup() {
  createCanvas(600, 400);
  groundY = height - 50;
  player = new Player();
  
  let jumpBtn = createButton('JUMP');
  jumpBtn.position(10, 10);
  jumpBtn.mousePressed(startGame);
}

function startGame() {
  gameStarted = true;
  player.jump();
}

function draw() {
  background(200);

  // Suelo
  fill(100);
  rect(0, groundY, width, height - groundY);

  if (gameStarted) {
    // Incrementa velocidad lentamente hasta un límite
    speed = min(speed + 0.001, 6);

    // Obstáculos
    if (frameCount % 150 === 0) {
      obstacles.push(new Obstacle());
    }

    for (let i = obstacles.length - 1; i >= 0; i--) {
      obstacles[i].update();
      obstacles[i].show();

      if (obstacles[i].hits(player)) {
        noLoop();
        fill(255, 0, 0);
        textSize(32);
        textAlign(CENTER);
        text('GAME OVER', width / 2, height / 2);
      }

      if (obstacles[i].offscreen()) {
        obstacles.splice(i, 1);
        score++;
      }
    }

    // Galletas
    if (frameCount % 300 === 0) {
      cookies.push(new Cookie());
    }

    for (let i = cookies.length - 1; i >= 0; i--) {
      cookies[i].update();
      cookies[i].show();

      if (cookies[i].collected(player)) {
        cookieSound.play();
        cookies.splice(i, 1);
        score += 5;
      } else if (cookies[i].offscreen()) {
        cookies.splice(i, 1);
      }
    }
  } else {
    fill(0);
    textSize(24);
    textAlign(CENTER);
    text('Pulsa JUMP para empezar', width / 2, height / 2);
  }

  player.update();
  player.show();

  fill(0);
  textSize(16);
  textAlign(LEFT);
  text('Score: ' + score, 10, 40);
}

// --------------------- Clases ---------------------

class Player {
  constructor() {
    this.x = 50;
    this.y = groundY;
    this.size = 40;
    this.ySpeed = 0;
    this.onGround = true;
  }

  jump() {
    if (this.onGround) {
      this.ySpeed = jumpForce;
      this.onGround = false;
      jumpSound.play();
    }
  }

  update() {
    this.ySpeed += gravity;
    this.y += this.ySpeed;

    if (this.y > groundY) {
      this.y = groundY;
      this.ySpeed = 0;
      this.onGround = true;
    }
  }

  show() {
    fill(255, 100, 100);
    rect(this.x, this.y - this.size, this.size, this.size);
  }
}

class Obstacle {
  constructor() {
    this.x = width;
    this.y = groundY;
    this.size = 40;
  }

  update() {
    this.x -= speed;
  }

  show() {
    fill(0);
    rect(this.x, this.y - this.size, this.size, this.size);
  }

  hits(player) {
    return (
      player.x < this.x + this.size &&
      player.x + player.size > this.x &&
      player.y > this.y - this.size
    );
  }

  offscreen() {
    return this.x + this.size < 0;
  }
}

class Cookie {
  constructor() {
    this.x = width;
    this.y = groundY - 20;
    this.size = 20;
  }

  update() {
    this.x -= speed;
  }

  show() {
    fill(255, 200, 0);
    ellipse(this.x + this.size / 2, this.y - this.size / 2, this.size);
  }

  collected(player) {
    return (
      player.x < this.x + this.size &&
      player.x + player.size > this.x &&
      player.y > this.y - this.size &&
      player.y < this.y + this.size
    );
  }

  offscreen() {
    return this.x + this.size < 0;
  }
}

// --------------------- Control con teclado ---------------------
function keyPressed() {
  if (key === ' ' || keyCode === UP_ARROW) {
    if (!gameStarted) startGame();
    else player.jump();
  }
}
